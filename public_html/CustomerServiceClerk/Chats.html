<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Service Clerk chats - Kubadu Services</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic CSS reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            width: 80%;
            margin: auto;
            overflow: hidden;
        }

        header {
            background: linear-gradient(90deg, #004AAD, #00BF63);
            color: #fff;
            padding: 20px 0;
            border-bottom: 3px solid #00C04B;
        }

        header h1 {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
        }

        main {
            padding: 20px 0;
        }

        /* Chat sections */
        .chat-section {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chat-box {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .chat-box h3 {
            text-align: center;
            color: #004AAD;
            margin-bottom: 10px;
        }

        .chat-box ul {
            list-style-type: none;
            padding: 0;
        }

        .chat-box li {
            padding: 10px;
            background-color: #f1f1f1;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-box li button {
            background-color: #004AAD;
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .chat-box li button:hover {
            background-color: #00BF63;
        }

        #chat-window {
            display: none;
            flex-direction: column;
            gap: 10px;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        #chat-window h2 {
            text-align: center;
            color: #004AAD;
        }

        #messages-list {
            list-style-type: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        #messages-list li {
            background-color: #f1f1f1;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        #message {
            width: calc(100% - 100px);
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            background-color: #004AAD;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #00BF63;
        }

        footer {
            text-align: center;
            color: #333;
            padding: 30px 0;
            border-top: 3px solid #77d667;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Customer service clerk Dashboard - Kubadu Services</h1>
        </div>
    </header>
    <main>
       <div id="available-chats">
    <h3>Available Chats</h3>
    <ul id="chat-list"></ul>
</div>
         <div id="Assigned-chats">
    <h3>Assigned chats</h3>
    <ul id="assigned-chat-list"></ul>
</div>
      
    </main>
    <div id="chat-window">
        <h2>Chat</h2>
        <ul id="messages-list"></ul> <!-- This is where messages will be listed -->
        <input type="text" id="message" placeholder="Type your message...">
        <button id="send-message-btn">Send</button>
        <button id="resolve-chat-btn">Resolve</button>
    </div>
    <footer>
        <div class="container">
            <p>&copy; 2024 Kubadu Services. All rights reserved.</p>
        </div>
    </footer>

<script>

// Toggle chat window visibility
function toggleChatWindow() {
    console.log("You are here now");
    const chatWindow = document.getElementById("chat-window");
    if (chatWindow.style.display === "none" || chatWindow.style.display === "") {
        chatWindow.style.display = "flex"; // Show the chat window
    } else {
        chatWindow.style.display = "none"; // Hide the chat window
    }
}

</script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
	import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
	import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAauhTRKCxnwpXvfdvRMXfU1K9oFvYgRRE",
        authDomain: "login-b62bd.firebaseapp.com",
        projectId: "login-b62bd",
        storageBucket: "login-b62bd.appspot.com",
        messagingSenderId: "861930818449",
        appId: "1:861930818449:web:1c5f962893ca85ecf5a830",
        measurementId: "G-KHJSX85R56"
    };

   let app;
if (!initializeApp.length) {
    app = initializeApp(firebaseConfig);
} else {
    app = initializeApp(firebaseConfig);
}

const auth = getAuth(app);
const db = getFirestore(app);
const analytics = getAnalytics(app);
var currentChatId = "";
onAuthStateChanged(auth, (user) => {
    if (user) {
        loadAssignedChats(); // Load assigned chats for the authenticated user
    } else {
        console.log("No user is logged in.");
        // Handle user not logged in (e.g., redirect to login page)
    }
});
const chatWindow = document.getElementById("chat-window");
  
        chatWindow.style.display = "none"; // Hide the chat window
    
    // Display all unassigned chats
   async function displayUnassignedChats() {
    const chatsQuery = query(collection(db, "chats"), where("status", "==", "unassigned"));
    const chatList = document.getElementById("chat-list");


    onSnapshot(chatsQuery, (snapshot) => {
        chatList.innerHTML = ''; 
        // Clear the list
         if (snapshot.empty) {
            // If no chats are available, show a message
            const noChatsMessage = document.createElement("li");
            noChatsMessage.textContent = "No chats available.";
            chatList.appendChild(noChatsMessage);
        }else{
        snapshot.forEach(doc => {
            const chatData = doc.data();
            const chatItem = document.createElement("li");
            chatItem.innerHTML = `Chat with Customer ${chatData.Name} ${chatData.Surname} <button class="assignChatBtn" data-chat-id="${doc.id}">Assign to Me</button>`;
            chatList.appendChild(chatItem);
        });
    }
    });
        
}


// Delegate event handling
document.addEventListener('DOMContentLoaded', function() {
    // Listen for clicks on the chat list
    document.getElementById("assigned-chat-list").addEventListener("click", function(event) {
        // Check if the clicked element is a button with the class "assignChatBtn"
        if (event.target.classList.contains("loadMessageBtn")) {
            const chatId = event.target.getAttribute("data-message-id");
            loadChatMessages(chatId);
        }
    });
    
        document.getElementById("resolve-chat-btn").addEventListener("click", function(event) {
            event.preventDefault();
        // Check if the clicked element is a button with the class "assignChatBtn"
        resolveChat(currentChatId);
    });
});
// Func
// chat-list
// tion to load messages for the assigned chat

// Event listener for chat assignment and sending messages
document.addEventListener('click', function(event) {
    // Check if an "Assign to Me" button was clicked
    if (event.target.classList.contains("assignChatBtn")) {
        const chatId = event.target.getAttribute("data-chat-id"); 
        currentChatId = chatId;// Get the chat ID directly from the clicked button
        assignChat(chatId);  // Assign the chat
    }

    // Check if the send message button was clicked
    if (event.target.id === "send-message-btn") {
        if (currentChatId) {
            sendMessageToChat(currentChatId);  // Send the message to the currently assigned chat
        } else {
            console.log("No chat is currently assigned.");
        }
    }
});
    

async function loadChatMessages(chatId) {
    // Fetch chat data to get the name and surname
    const chatRef = doc(db, "chats", chatId); // Reference to the chat document
    const chatDoc = await getDoc(chatRef); // Fetch the chat document

    if (!chatDoc.exists()) {
        console.error("Chat not found!");
        return;
    }

    const chatData = chatDoc.data(); // Get chat data (Name and Surname)
    const messagesQuery = query(collection(db, `chats/${chatId}/messages`)); // Query messages subcollection
    const messagesList = document.getElementById("messages-list");

    if (!messagesList) {
        console.error("Messages list element not found!");
        return;
    }

    onSnapshot(messagesQuery, (snapshot) => {
        console.log("Snapshot received:", snapshot);
        if (snapshot.empty) {
            console.log("No messages found for this chat.");
            return;
        }

        messagesList.innerHTML = ''; // Clear existing messages
        snapshot.forEach(doc => {
            currentChatId = chatId;
            const messageData = doc.data();
            const messageItem = document.createElement("li");

            // Use chatData for Name and Surname and messageData for message content and timestamp
            messageItem.innerText = `${messageData.timestamp.toDate().toLocaleString()} - ${chatData.name} ${chatData.surname}: ${messageData.message}`;
            messagesList.appendChild(messageItem);
        });
    });
}

// Function to mark a chat as resolved
async function resolveChat(chatId) {
    const chatDocRef = doc(db, "chats", chatId);

    try {
        await updateDoc(chatDocRef, {
            status: "resolved",
            resolvedAt: new Date() // Optionally, add a timestamp of when the chat was resolved
        });
        console.log("Chat marked as resolved.");
    } catch (error) {
        console.error("Error resolving chat:", error);
    }
}

// Function to assign the chat to a clerk
async function assignChat(chatId) {
    const clerkID = auth.currentUser.uid;  // Get the current clerk's ID
    const chatDocRef = doc(db, "chats", chatId);

    try {
        await updateDoc(chatDocRef, {
            clerk_assigned: clerkID,
            status: "open" // Update status to assigned
            
        });
        alert("Chat assigned to you. You can now start the conversation.");
        loadChatMessages(chatId); // Load messages for this chat after assignment
    } catch (error) {
        console.error("Error assigning chat: ", error);
    }
}
async function loadAssignedChats() {
    console.log("YOU ARE HERE NOEW");
    const user = auth.currentUser;  // Get the currently logged-in user
    const assignedChatsQuery = query(collection(db, "chats"), where("clerk_assigned", "==", user.uid),where("status", "==", "open"));
    const assignedChatList = document.getElementById("assigned-chat-list"); // Make sure this element exists

    if (!assignedChatList) {
        console.error("Assigned chat list element not found!");
        return;  // Exit the function if the element is not found
    }

    onSnapshot(assignedChatsQuery, (snapshot) => {
        assignedChatList.innerHTML = ''; // Clear existing chats
        snapshot.forEach(doc => {
            const chatData = doc.data();
            const chatItem = document.createElement("li");
            chatItem.innerHTML = `Chat with Customer: ${chatData.name} ${chatData.surname}  <button class="loadMessageBtn" onclick="toggleChatWindow()" data-message-id="${doc.id}">Open Chat</button>View Messages</button>`;
           console.log(chatData);
                assignedChatList.appendChild(chatItem);
        });
    });
}

// Load assigned chats on window load
window.onload = async function() {
    const user = auth.currentUser; // Check if the user is logged in

    if (user) {
        await loadAssignedChats(); // Only call this function if the user is logged in
    } else {
        console.log("User is not logged in. Cannot load assigned chats.");
        // Optionally, redirect to login page or show a message
    }
};


async function sendMessageToChat(chatId) {
            const user = auth.currentUser;
            const messageInput = document.getElementById("message");

            if (user) {
                const message = messageInput.value.trim();

                if (message !== "") {
                    const chatDocRef = doc(db, "chats", chatId);
                    const messageData = {
                        userID: user.uid,
                        name: user.displayName || "Anonymous",
                        message: message,
                        timestamp: new Date()
                    };

                    try {
                        await addDoc(collection(chatDocRef, "messages"), messageData);
                        messageInput.value = "";  // Clear input field after sending
                        loadChatMessages(chatId);  // Reload messages after sending
                    } catch (error) {
                        console.error("Error sending message: ", error);
                    }
                } else {
                    console.log("Message cannot be empty.");
                }
            } else {
                console.log("No user is currently logged in.");
            }
        }



    window.onload = function() {
        displayUnassignedChats();
      
        
    };
</script>
</body>
</html>